{"version":3,"sources":["../../src/graphqlData/resolvers.js"],"names":["uploadDir","mkdirp","sync","storeFS","stream","filename","id","shortid","generate","path","url","console","log","Promise","resolve","reject","on","error","truncated","fs","unlinkSync","pipe","createWriteStream","processUpload","upload","mimetype","encoding","resolvers","Query","class","_","db","models","findById","classes","args","findAll","deck","decks","cards","card","where","deck_id","order","pools","pool","games","result","game","Game","standOnCards","game_id","hasMany","game_cards_stand","foreignKey","belongsTo","include","model","Pool","pool_id","pool_cards","Mutation","upsertClass","upsert","upsertClasses","map","cl","then","upsertedCl","findOne","deleteClasses","c","destroy","upsertDecks","upsertedDeck","deleteDecks","upsertPools","fields","Object","keys","card_id","length","bulkCreate","deletePools","upsertCards","obj","promisesAll","all","image","err","name","split","forEach","message","deleteCards","dbSuccess","fsSuccess","urlComponents","deleteFile","deleteGames","q1","q2","upsertGames","game_cards","Upload","GraphQLUpload","unlink"],"mappings":";;;;;;AAAA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,MAAMA,YAAY,uBAAlB;;AAEA;AACAC,iBAAOC,IAAP,CAAYF,SAAZ;;AAEA,MAAMG,UAAU,CAAC,EAACC,MAAD,EAASC,QAAT,EAAD,KAAwB;AACvC,OAAMC,KAAKC,kBAAQC,QAAR,EAAX;AACA,OAAMC,OAAQ,GAAET,SAAU,IAAGM,EAAG,IAAGD,QAAS,EAA5C;AACA,OAAMK,MAAO,wBAAuBJ,EAAG,IAAGD,QAAS,EAAnD;AACAM,SAAQC,GAAR,CAAY,KAAZ,EAAmBF,GAAnB;AACA,QAAO,IAAIG,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAClBX,OACCY,EADD,CACI,OADJ,EACaC,SAAS;AACrB,MAAIb,OAAOc,SAAX;AACA;AACCC,gBAAGC,UAAH,CAAcX,IAAd;AACDM,SAAOE,KAAP;AACA,EAND,EAOCI,IAPD,CAOMF,aAAGG,iBAAH,CAAqBb,IAArB,CAPN,EAQCO,EARD,CAQI,OARJ,EAQaC,SAASF,OAAOE,KAAP,CARtB,EASCD,EATD,CASI,QATJ,EASc,MAAMF,QAAQ,EAACR,EAAD,EAAKG,IAAL,EAAWC,GAAX,EAAR,CATpB,CADM,CAAP;AAYA,CAjBD;;AAmBA,MAAMa,gBAAgB,MAAMC,MAAN,IAAgB;AACrC,OAAM,EAACpB,MAAD,EAASC,QAAT,EAAmBoB,QAAnB,EAA6BC,QAA7B,KAAyC,MAAMF,MAArD;AACA,OAAM,EAAClB,EAAD,EAAKG,IAAL,EAAWC,GAAX,KAAkB,MAAMP,QAAQ,EAACC,MAAD,EAASC,QAAT,EAAR,CAA9B;AACA,QAAO,EAACK,GAAD,EAAMD,IAAN,EAAYJ,QAAZ,EAAP;AACA,CAJD;;AAOA,MAAMsB,YAAY;AACjBC,QAAO;AACNC,SAAO,CAACC,CAAD,EAAI,EAACxB,EAAD,EAAJ,KAAayB,aAAGC,MAAH,CAAUH,KAAV,CAAgBI,QAAhB,CAAyB3B,EAAzB,CADd;AAEN4B,WAAS,CAACJ,CAAD,EAAIK,IAAJ,KAAaJ,aAAGC,MAAH,CAAUH,KAAV,CAAgBO,OAAhB,EAFhB;AAGNC,QAAM,CAACP,CAAD,EAAI,EAACxB,EAAD,EAAJ,KAAayB,aAAGC,MAAH,CAAUK,IAAV,CAAeJ,QAAf,CAAwB3B,EAAxB,CAHb;AAINgC,SAAO,CAACR,CAAD,EAAIK,IAAJ,KAAaJ,aAAGC,MAAH,CAAUK,IAAV,CAAeD,OAAf,EAJd;AAKNG,SAAO,CAACT,CAAD,EAAIK,IAAJ,KAAaJ,aAAGC,MAAH,CAAUQ,IAAV,CAAeJ,OAAf,CAAuB;AAC1CK,UAAO,EAACC,SAASP,KAAKO,OAAf,EADmC;AAE1CC,UAAO,CAAC,CAAC,OAAD,CAAD;AAFmC,GAAvB,CALd;AASNC,SAAO,CAACd,CAAD,EAAIK,IAAJ,KAAaJ,aAAGC,MAAH,CAAUa,IAAV,CAAeT,OAAf,CAAuB;AAC1CK,UAAO,EAACC,SAASP,KAAKO,OAAf;AADmC,GAAvB,CATd;AAYNI,SAAO,OAAOhB,CAAP,EAAUK,IAAV,KAAmB;AACzB;AACA,OAAIY,SAAS,MAAMhB,aAAGC,MAAH,CAAUgB,IAAV,CAAeZ,OAAf,CAAuB;AACzCK,WAAO,EAACC,SAASP,KAAKO,OAAf;AADkC,IAAvB,CAAnB;;AAIA;AACA,UAAOK,MAAP;AACA;;AApBK,EADU;;AAyBjBE,OAAM;AACLC,gBAAc,OAAO,EAAC5C,IAAI6C,OAAL,EAAP,KAAyB;AACtC;AACApB,gBAAGC,MAAH,CAAUQ,IAAV,CAAeY,OAAf,CAAuBrB,aAAGC,MAAH,CAAUqB,gBAAjC,EAAmD,EAACC,YAAY,SAAb,EAAnD;AACAvB,gBAAGC,MAAH,CAAUqB,gBAAV,CAA2BE,SAA3B,CAAqCxB,aAAGC,MAAH,CAAUQ,IAA/C,EAAqD,EAACc,YAAY,SAAb,EAArD;;AAEA,OAAIf,QAAQ,MAAMR,aAAGC,MAAH,CAAUQ,IAAV,CAAeJ,OAAf,CAAuB;AACxCoB,aAAS,CAAC;AACTC,YAAO1B,aAAGC,MAAH,CAAUqB,gBADR;AAETZ,YAAO,EAACU,OAAD;AAFE,KAAD;AAD+B,IAAvB,CAAlB;;AAOA;AACA,UAAOZ,KAAP;AACA;AAfI,EAzBW;;AA2CjBmB,OAAM;AACLnB,SAAO,OAAO,EAACjC,IAAIqD,OAAL,EAAP,KAAyB;AAC/B;AACA5B,gBAAGC,MAAH,CAAUQ,IAAV,CAAeY,OAAf,CAAuBrB,aAAGC,MAAH,CAAU4B,UAAjC,EAA6C,EAACN,YAAY,SAAb,EAA7C;AACAvB,gBAAGC,MAAH,CAAU4B,UAAV,CAAqBL,SAArB,CAA+BxB,aAAGC,MAAH,CAAUQ,IAAzC,EAA+C,EAACc,YAAY,SAAb,EAA/C;;AAEA,OAAIf,QAAQ,MAAMR,aAAGC,MAAH,CAAUQ,IAAV,CAAeJ,OAAf,CAAuB;AACxCoB,aAAS,CAAC;AACTC,YAAO1B,aAAGC,MAAH,CAAU4B,UADR;AAETnB,YAAO,EAACkB,OAAD;AAFE,KAAD,CAD+B;AAKxChB,WAAO,CAAC,CAAC,OAAD,CAAD;AALiC,IAAvB,CAAlB;AAOA,UAAOJ,KAAP;AACA;AAdI,EA3CW;;AA4DjBsB,WAAU;AACTC,eAAa,CAAChC,CAAD,EAAIK,IAAJ,KAAaJ,aAAGC,MAAH,CAAUH,KAAV,CAAgBkC,MAAhB,CAAuB5B,IAAvB,CADjB;AAET6B,iBAAe,CAAClC,CAAD,EAAI,EAACI,OAAD,EAAJ,KAAkB;AAChC,UAAOA,QAAQ+B,GAAR,CAAaC,EAAD,IAAQ;AAC1B,WAAOnC,aAAGC,MAAH,CAAUH,KAAV,CAAgBkC,MAAhB,CAAuBG,EAAvB,EAA2BC,IAA3B,CAAgC,MAAM;AAC5C,SAAIC,UAAJ;;AAEA,SAAI,CAACF,GAAG5D,EAAR,EAAY;AACX8D,mBAAarC,aAAGC,MAAH,CAAUH,KAAV,CAAgBwC,OAAhB,CAAwB;AACpC,gBAAS,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD;AAD2B,OAAxB,CAAb;AAGA,MAJD,MAIO;AACND,mBAAarC,aAAGC,MAAH,CAAUH,KAAV,CAAgBI,QAAhB,CAAyBiC,GAAG5D,EAA5B,CAAb;AACA;;AAED,YAAO8D,UAAP;AACA,KAZM,CAAP;AAaA,IAdM,CAAP;AAeA,GAlBQ;AAmBTE,iBAAe,CAACxC,CAAD,EAAI,EAACI,OAAD,EAAJ,KAAkB;AAChC;AACA,UAAOA,QAAQ+B,GAAR,CAAYM,KAAKxC,aAAGC,MAAH,CAAUH,KAAV,CAAgB2C,OAAhB,CAAwB;AAC/C/B,WAAO,EAACnC,IAAIiE,EAAEjE,EAAP;AADwC,IAAxB,CAAjB,CAAP;AAGA,GAxBQ;AAyBTmE,eAAa,CAAC3C,CAAD,EAAI,EAACQ,KAAD,EAAJ,KAAgB;AAC5B,UAAOA,MAAM2B,GAAN,CAAW5B,IAAD,IAAU;AAC1B,WAAON,aAAGC,MAAH,CAAUK,IAAV,CAAe0B,MAAf,CAAsB1B,IAAtB,EAA4B8B,IAA5B,CAAiC,MAAI;AAC3C,SAAIO,YAAJ;;AAEA,SAAG,CAACrC,KAAK/B,EAAT,EAAa;AACZoE,qBAAe3C,aAAGC,MAAH,CAAUK,IAAV,CAAegC,OAAf,CAAuB;AACrC,gBAAS,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD;AAD4B,OAAvB,CAAf;AAGA,MAJD,MAIO;AACNK,qBAAe3C,aAAGC,MAAH,CAAUK,IAAV,CAAeJ,QAAf,CAAwBI,KAAK/B,EAA7B,CAAf;AACA;;AAED,YAAOoE,YAAP;AACA,KAZM,CAAP;AAaA,IAdM,CAAP;AAeA,GAzCQ;AA0CTC,eAAa,CAAC7C,CAAD,EAAI,EAACQ,KAAD,EAAJ,KAAgB;AAC5B;AACA,UAAOA,MAAM2B,GAAN,CAAUM,KAAKxC,aAAGC,MAAH,CAAUK,IAAV,CAAemC,OAAf,CAAuB;AAC5C/B,WAAO,EAACnC,IAAIiE,EAAEjE,EAAP;AADqC,IAAvB,CAAf,CAAP;AAGA,GA/CQ;AAgDTsE,eAAa,CAAC9C,CAAD,EAAI,EAACc,KAAD,EAAJ,KAAgB;AAC5B;AACA,UAAOA,MAAMqB,GAAN,CAAWpB,IAAD,IAAU;AAC1B,QAAIgC,SAASC,OAAOC,IAAP,CAAYlC,IAAZ,CAAb;;AAEA;AACA,WAAOd,aAAGC,MAAH,CAAUa,IAAV,CAAekB,MAAf,CAAsBlB,IAAtB,EAA4B,EAACgC,MAAD,EAA5B,EAAsCV,IAAtC,CAA2C,MAAOpB,MAAP,IAAkB;AACnE,SAAIR,QAAQM,KAAKN,KAAjB;;AAEA,SAAI,CAACM,KAAKvC,EAAV,EAAc;AACbuC,aAAO,MAAMd,aAAGC,MAAH,CAAUa,IAAV,CAAewB,OAAf,CAAuB;AACnC,gBAAS,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD;AAD0B,OAAvB,CAAb;AAGA;;AAED1D,aAAQC,GAAR,CAAY,MAAZ,EAAoBiC,IAApB;AACA;AACAlC,aAAQC,GAAR,CAAY,OAAZ,EAAqB2B,KAArB;;AAEA,SAAIA,KAAJ,EAAW;AACV;AACA,YAAMR,aAAGC,MAAH,CAAU4B,UAAV,CAAqBY,OAArB,CAA6B;AAClC/B,cAAO;AACNkB,iBAASd,KAAKvC;AADR;AAD2B,OAA7B,CAAN;;AAMA,UAAIsD,aAAarB,MAAM0B,GAAN,CAAWzB,IAAD,IAAU;AACpC,cAAO;AACNmB,iBAASd,KAAKvC,EADR;AAEN0E,iBAASxC,KAAKlC;AAFR,QAAP;AAIA,OALgB,CAAjB;;AAQA,UAAGsD,WAAWqB,MAAd,EAAsB;AACrB,aAAMlD,aAAGC,MAAH,CAAU4B,UAAV,CAAqBsB,UAArB,CAAgCtB,UAAhC,EACL;AACCiB,gBAAQC,OAAOC,IAAP,CAAYnB,WAAW,CAAX,CAAZ;AADT,QADK,CAAN;AAIA;AACD;;AAGDf,YAAO,MAAMd,aAAGC,MAAH,CAAUa,IAAV,CAAeZ,QAAf,CAAwBY,KAAKvC,EAA7B,CAAb;;AAEA,YAAOuC,IAAP;AACA,KAzCM,CAAP;AA0CA,IA9CM,CAAP;AA+CA,GAjGQ;;AAoGTsC,eAAa,CAACrD,CAAD,EAAI,EAACc,KAAD,EAAJ,KAAgB;AAC5B;AACA,UAAOA,MAAMqB,GAAN,CAAUM,KAAKxC,aAAGC,MAAH,CAAUa,IAAV,CAAe2B,OAAf,CAAuB;AAC5C/B,WAAO,EAACnC,IAAIiE,EAAEjE,EAAP;AADqC,IAAvB,CAAf,CAAP;AAGA,GAzGQ;AA0GT8E,eAAa,OAAOC,GAAP,EAAY,EAAC9C,KAAD,EAAZ,KAAwB;AACpC5B,WAAQC,GAAR,CAAY,OAAZ,EAAqB2B,KAArB;AACA,SAAM,EAACzB,OAAD,EAAUC,MAAV,KAAoB,MAAMuE,sBAAYC,GAAZ,CAC/BhD,MAAM0B,GAAN,CAAU,MAAOzB,IAAP,IAAgB;AACzB,QAAIgD,QAAQ,MAAMhD,KAAKgD,KAAvB;AACA7E,YAAQC,GAAR,CAAY,OAAZ,EAAqB4E,KAArB;AACA,QAAIA,SAAS,OAAOA,KAAP,KAAiB,QAA9B,EAAwC;AACvC,SAAI;AACH,UAAI,EAAC9E,GAAD,EAAML,QAAN,KAAkB,MAAMkB,cAAciE,KAAd,CAA5B;;AAEA7E,cAAQC,GAAR,CAAY,KAAZ,EAAmBF,GAAnB;AACA8B,+BAAWA,IAAX,IAAiBgD,OAAO9E,GAAxB;AACAC,cAAQC,GAAR,CAAY,MAAZ,EAAoB4B,IAApB;AACA,MAND,CAME,OAAOiD,GAAP,EAAY;AACb,UAAIA,GAAJ,EAAS9E,QAAQM,KAAR,CAAcwE,GAAd;AACT;AACD;;AAED,QAAI,CAACjD,KAAKlC,EAAN,IAAY,CAACkC,KAAKkD,IAAlB,IAA0BrF,QAA9B,EAAwC;AACvCmC,UAAKkD,IAAL,GAAYrF,SAASsF,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAZ;AACA;;AAEDhF,YAAQC,GAAR,CAAY,YAAZ,EAA0B4B,KAAKgD,KAA/B;AACA,UAAMzD,aAAGC,MAAH,CAAUQ,IAAV,CAAeuB,MAAf,CAAsBvB,IAAtB,CAAN;;AAEA,QAAIO,MAAJ;;AAEA,QAAIP,KAAKlC,EAAT,EAAa;AACZyC,cAAS,MAAMhB,aAAGC,MAAH,CAAUQ,IAAV,CAAeP,QAAf,CAAwBO,KAAKlC,EAA7B,CAAf;AACA,KAFD,MAEO;AACNyC,cAAS,MAAMhB,aAAGC,MAAH,CAAUQ,IAAV,CAAe6B,OAAf,CAAuB;AACrC,eAAS,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD;AAD4B,MAAvB,CAAf;AAGA;;AAED,WAAOtB,MAAP;AACA,IAjCD,CAD+B,CAAhC;;AAqCA,OAAIhC,OAAOkE,MAAX,EACClE,OAAO6E,OAAP,CAAe,CAAC,EAACF,IAAD,EAAOG,OAAP,EAAD;AACd;AACAlF,WAAQM,KAAR,CAAe,GAAEyE,IAAK,KAAIG,OAAQ,EAAlC,CAFD;;AAKD,UAAO/E,OAAP;AACA,GAxJQ;AAyJTgF,eAAa,OAAOhE,CAAP,EAAU,EAACS,KAAD,EAAV,KAAsB;AAClC;AACA,UAAOA,MAAM0B,GAAN,CAAU,MAAOM,CAAP,IAAa;AAC7B,QAAI/B,OAAO,MAAMT,aAAGC,MAAH,CAAUQ,IAAV,CAAeP,QAAf,CAAwBsC,EAAEjE,EAA1B,CAAjB;;AAEA,QAAIyF,SAAJ,EAAeC,SAAf;;AAEAD,gBAAY,MAAMhE,aAAGC,MAAH,CAAUQ,IAAV,CAAegC,OAAf,CAAuB;AACxC/B,YAAO,EAACnC,IAAIiE,EAAEjE,EAAP;AADiC,KAAvB,CAAlB;;AAIA,QAAIyF,aAAavD,KAAKgD,KAAtB,EAA6B;AAC5B,SAAIS,gBAAgBzD,KAAKgD,KAAL,CAAWG,KAAX,CAAiB,GAAjB,CAApB;AACA,SAAItF,WAAW4F,cAAcA,cAAchB,MAAd,GAAuB,CAArC,CAAf;AACA,SAAIxE,OAAQ,yBAAwBJ,QAAS,EAA7C;AACA2F,iBAAY,MAAME,WAAWzF,IAAX,CAAlB;AACA;;AAED,WAAOsF,aAAaC,SAApB;AACA,IAjBM,CAAP;AAkBA,GA7KQ;;AA+KTG,eAAa,OAAOrE,CAAP,EAAU,EAACgB,KAAD,EAAV,KAAsB;AAClC;AACA,UAAOjC,QAAQ0E,GAAR,CAAYzC,MAAMmB,GAAN,CAAU,MAAOjB,IAAP,IAAgB;AAC5C,QAAIoD,KAAKrE,aAAGC,MAAH,CAAUqB,gBAAV,CAA2BmB,OAA3B,CAAmC;AAC3C/B,YAAO,EAACU,SAASH,KAAK1C,EAAf;AADoC,KAAnC,CAAT;;AAIA,QAAI+F,KAAKtE,aAAGC,MAAH,CAAUgB,IAAV,CAAewB,OAAf,CAAuB;AAC/B/B,YAAO,EAACnC,IAAI0C,KAAK1C,EAAV;AADwB,KAAvB,CAAT;;AAIA,WAAQO,QAAQ0E,GAAR,CAAY,CAACa,EAAD,EAAKC,EAAL,CAAZ,CAAR;AACA,IAVkB,CAAZ,CAAP;AAWA,GA5LQ;;AA8LTC,eAAa,CAACxE,CAAD,EAAI,EAACgB,KAAD,EAAJ,KAAgB;AAC5BnC,WAAQC,GAAR,CAAY,OAAZ,EAAqBkC,KAArB;AACA,UAAOA,MAAMmB,GAAN,CAAWjB,IAAD,IAAU;AAC1B,QAAI6B,SAASC,OAAOC,IAAP,CAAY/B,IAAZ,CAAb;;AAEA;AACA,WAAOjB,aAAGC,MAAH,CAAUgB,IAAV,CAAee,MAAf,CAAsBf,IAAtB,EAA4B,EAAC6B,MAAD,EAA5B,EAAsCV,IAAtC,CAA2C,MAAOpB,MAAP,IAAkB;AACnE,SAAIG,eAAeF,KAAKE,YAAxB;;AAEA,SAAI,CAACF,KAAK1C,EAAV,EAAc;AACb0C,aAAO,MAAMjB,aAAGC,MAAH,CAAUgB,IAAV,CAAeqB,OAAf,CAAuB;AACnC,gBAAS,CAAC,CAAC,IAAD,EAAO,MAAP,CAAD;AAD0B,OAAvB,CAAb;AAGA;;AAED;AACA;;;AAGA,SAAInB,YAAJ,EAAkB;AACjB;AACA,YAAMnB,aAAGC,MAAH,CAAUqB,gBAAV,CAA2BmB,OAA3B,CAAmC;AACxC/B,cAAO;AACNU,iBAASH,KAAK1C;AADR;AADiC,OAAnC,CAAN;;AAMA,UAAIiG,aAAarD,aAAae,GAAb,CAAkBzB,IAAD,IAAU;AAC3C,cAAO;AACNW,iBAASH,KAAK1C,EADR;AAEN0E,iBAASxC,KAAKlC;AAFR,QAAP;AAIA,OALgB,CAAjB;;AAQA,UAAGiG,WAAWtB,MAAd,EAAsB;AACrB,aAAMlD,aAAGC,MAAH,CAAUqB,gBAAV,CAA2B6B,UAA3B,CAAsCqB,UAAtC,EACL;AACC1B,gBAAQC,OAAOC,IAAP,CAAYwB,WAAW,CAAX,CAAZ;AADT,QADK,CAAN;AAIA;AACD;;AAGDvD,YAAO,MAAMjB,aAAGC,MAAH,CAAUgB,IAAV,CAAef,QAAf,CAAwBe,KAAK1C,EAA7B,CAAb;;AAEA,YAAO0C,IAAP;AACA,KAzCM,CAAP;AA0CA,IA9CM,CAAP;AA+CA;AA/OQ,EA5DO;;AA8SjBwD,SAAQC;AA9SS,CAAlB;;AAiTA,eAAeP,UAAf,CAA0BzF,IAA1B,EAAgC;AAC/B,QAAO,IAAII,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvCI,eAAGuF,MAAH,CAAUjG,IAAV,EAAiBgF,GAAD,IAAS;AACxB,OAAIA,GAAJ,EAAS;AACR9E,YAAQM,KAAR,CAAcwE,GAAd;AACA,UAAMA,GAAN;AACA1E,WAAO,KAAP;AACA,IAJD,MAIO;AACND,YAAQ,IAAR;AACA;AACD,GARD;AASA,EAVM,CAAP;AAWA;;kBAEca,S","file":"resolvers.js","sourcesContent":["import db from '../db';\nimport {GraphQLUpload} from 'apollo-upload-server'\nimport fs from 'fs'\nimport mkdirp from 'mkdirp'\nimport shortid from 'shortid'\nimport promisesAll from 'promises-all'\n\nconst uploadDir = './assets/images/cards';\n\n// Ensure upload directory exists\nmkdirp.sync(uploadDir)\n\nconst storeFS = ({stream, filename}) => {\n\tconst id = shortid.generate()\n\tconst path = `${uploadDir}/${id}-${filename}`\n\tconst url = `/assets/images/cards/${id}-${filename}`\n\tconsole.log(\"url\", url);\n\treturn new Promise((resolve, reject) =>\n\t\tstream\n\t\t.on('error', error => {\n\t\t\tif (stream.truncated)\n\t\t\t// Delete the truncated file\n\t\t\t\tfs.unlinkSync(path)\n\t\t\treject(error)\n\t\t})\n\t\t.pipe(fs.createWriteStream(path))\n\t\t.on('error', error => reject(error))\n\t\t.on('finish', () => resolve({id, path, url}))\n\t)\n}\n\nconst processUpload = async upload => {\n\tconst {stream, filename, mimetype, encoding} = await upload\n\tconst {id, path, url} = await storeFS({stream, filename})\n\treturn {url, path, filename};\n}\n\n\nconst resolvers = {\n\tQuery: {\n\t\tclass: (_, {id}) => db.models.class.findById(id),\n\t\tclasses: (_, args) => db.models.class.findAll(),\n\t\tdeck: (_, {id}) => db.models.deck.findById(id),\n\t\tdecks: (_, args) => db.models.deck.findAll(),\n\t\tcards: (_, args) => db.models.card.findAll({\n\t\t\twhere: {deck_id: args.deck_id},\n\t\t\torder: [['order']]\n\t\t}),\n\t\tpools: (_, args) => db.models.pool.findAll({\n\t\t\twhere: {deck_id: args.deck_id}\n\t\t}),\n\t\tgames: async (_, args) => {\n\t\t\t//console.log(\"args\", args);\n\t\t\tlet result = await db.models.game.findAll({\n\t\t\t\twhere: {deck_id: args.deck_id}\n\t\t\t})\n\t\t\t\n\t\t\t//console.log(\"result\", result);\n\t\t\treturn result;\n\t\t},\n\t\t\n\t},\n\t\n\tGame: {\n\t\tstandOnCards: async ({id: game_id}) => {\n\t\t\t//console.log(\"game_id\", game_id);\n\t\t\tdb.models.card.hasMany(db.models.game_cards_stand, {foreignKey: 'card_id'});\n\t\t\tdb.models.game_cards_stand.belongsTo(db.models.card, {foreignKey: 'card_id'});\n\t\t\t\n\t\t\tlet cards = await db.models.card.findAll({\n\t\t\t\tinclude: [{\n\t\t\t\t\tmodel: db.models.game_cards_stand,\n\t\t\t\t\twhere: {game_id}\n\t\t\t\t}]\n\t\t\t});\n\t\t\t\n\t\t\t//console.log(\"cards\", cards);\n\t\t\treturn cards;\n\t\t}\n\t},\n\t\n\tPool: {\n\t\tcards: async ({id: pool_id}) => {\n\t\t\t//console.log(\"pool_id\", pool_id);\n\t\t\tdb.models.card.hasMany(db.models.pool_cards, {foreignKey: 'card_id'});\n\t\t\tdb.models.pool_cards.belongsTo(db.models.card, {foreignKey: 'card_id'});\n\t\t\t\n\t\t\tlet cards = await db.models.card.findAll({\n\t\t\t\tinclude: [{\n\t\t\t\t\tmodel: db.models.pool_cards,\n\t\t\t\t\twhere: {pool_id}\n\t\t\t\t}],\n\t\t\t\torder: [['order']]\n\t\t\t});\n\t\t\treturn cards;\n\t\t}\n\t},\n\t\n\tMutation: {\n\t\tupsertClass: (_, args) => db.models.class.upsert(args),\n\t\tupsertClasses: (_, {classes}) => {\n\t\t\treturn classes.map((cl) => {\n\t\t\t\treturn db.models.class.upsert(cl).then(() => {\n\t\t\t\t\tlet upsertedCl;\n\t\t\t\t\t\n\t\t\t\t\tif (!cl.id) {\n\t\t\t\t\t\tupsertedCl = db.models.class.findOne({\n\t\t\t\t\t\t\t'order': [['id', 'DESC']]\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tupsertedCl = db.models.class.findById(cl.id);\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\treturn upsertedCl;\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\tdeleteClasses: (_, {classes}) => {\n\t\t\t//console.log(\"classes\", classes);\n\t\t\treturn classes.map(c => db.models.class.destroy({\n\t\t\t\twhere: {id: c.id}\n\t\t\t}))\n\t\t},\n\t\tupsertDecks: (_, {decks}) => {\n\t\t\treturn decks.map((deck) => {\n\t\t\t\treturn db.models.deck.upsert(deck).then(()=>{\n\t\t\t\t\tlet upsertedDeck;\n\t\t\t\t\t\n\t\t\t\t\tif(!deck.id) {\n\t\t\t\t\t\tupsertedDeck = db.models.deck.findOne({\n\t\t\t\t\t\t\t'order': [['id', 'DESC']]\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tupsertedDeck = db.models.deck.findById(deck.id);\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\treturn upsertedDeck;\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\tdeleteDecks: (_, {decks}) => {\n\t\t\t//console.log(\"decks\", decks);\n\t\t\treturn decks.map(c => db.models.deck.destroy({\n\t\t\t\twhere: {id: c.id}\n\t\t\t}))\n\t\t},\n\t\tupsertPools: (_, {pools}) => {\n\t\t\t//console.log(\"pools\", pools);\n\t\t\treturn pools.map((pool) => {\n\t\t\t\tlet fields = Object.keys(pool);\n\t\t\t\t\n\t\t\t\t//console.log(\"fields\", fields);\n\t\t\t\treturn db.models.pool.upsert(pool, {fields}).then(async (result) => {\n\t\t\t\t\tlet cards = pool.cards;\n\t\t\t\t\t\n\t\t\t\t\tif (!pool.id) {\n\t\t\t\t\t\tpool = await db.models.pool.findOne({\n\t\t\t\t\t\t\t'order': [['id', 'DESC']]\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tconsole.log(\"pool\", pool);\n\t\t\t\t\t//console.log(\"pool.id\", pool.id);\n\t\t\t\t\tconsole.log(\"cards\", cards);\n\t\t\t\t\t\n\t\t\t\t\tif (cards) {\n\t\t\t\t\t\t// delete existing pool_cards\n\t\t\t\t\t\tawait db.models.pool_cards.destroy({\n\t\t\t\t\t\t\twhere: {\n\t\t\t\t\t\t\t\tpool_id: pool.id,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tlet pool_cards = cards.map((card) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tpool_id: pool.id,\n\t\t\t\t\t\t\t\tcard_id: card.id,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(pool_cards.length) {\n\t\t\t\t\t\t\tawait db.models.pool_cards.bulkCreate(pool_cards,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfields: Object.keys(pool_cards[0]),\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tpool = await db.models.pool.findById(pool.id);\n\t\t\t\t\t\n\t\t\t\t\treturn pool;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\t\n\t\t,\n\t\tdeletePools: (_, {pools}) => {\n\t\t\t//console.log(\"pools\", pools);\n\t\t\treturn pools.map(c => db.models.pool.destroy({\n\t\t\t\twhere: {id: c.id}\n\t\t\t}))\n\t\t},\n\t\tupsertCards: async (obj, {cards}) => {\n\t\t\tconsole.log(\"cards\", cards);\n\t\t\tconst {resolve, reject} = await promisesAll.all(\n\t\t\t\tcards.map(async (card) => {\n\t\t\t\t\tlet image = await card.image;\n\t\t\t\t\tconsole.log(\"image\", image);\n\t\t\t\t\tif (image && typeof image !== 'string') {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar {url, filename} = await processUpload(image);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tconsole.log(\"url\", url);\n\t\t\t\t\t\t\tcard = {...card, image: url};\n\t\t\t\t\t\t\tconsole.log(\"card\", card);\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tif (err) console.error(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif (!card.id && !card.name && filename) {\n\t\t\t\t\t\tcard.name = filename.split('.')[0];\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tconsole.log(\"card.image\", card.image);\n\t\t\t\t\tawait db.models.card.upsert(card);\n\t\t\t\t\t\n\t\t\t\t\tlet result;\n\t\t\t\t\t\n\t\t\t\t\tif (card.id) {\n\t\t\t\t\t\tresult = await db.models.card.findById(card.id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult = await db.models.card.findOne({\n\t\t\t\t\t\t\t'order': [['id', 'DESC']]\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\treturn result;\n\t\t\t\t})\n\t\t\t)\n\t\t\t\n\t\t\tif (reject.length)\n\t\t\t\treject.forEach(({name, message}) =>\n\t\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\t\tconsole.error(`${name}: ${message}`)\n\t\t\t\t)\n\t\t\t\n\t\t\treturn resolve\n\t\t},\n\t\tdeleteCards: async (_, {cards}) => {\n\t\t\t//console.log(\"cards\", cards);\n\t\t\treturn cards.map(async (c) => {\n\t\t\t\tlet card = await db.models.card.findById(c.id);\n\t\t\t\t\n\t\t\t\tlet dbSuccess, fsSuccess;\n\t\t\t\t\n\t\t\t\tdbSuccess = await db.models.card.destroy({\n\t\t\t\t\twhere: {id: c.id}\n\t\t\t\t})\n\t\t\t\t\n\t\t\t\tif (dbSuccess && card.image) {\n\t\t\t\t\tlet urlComponents = card.image.split('/');\n\t\t\t\t\tlet filename = urlComponents[urlComponents.length - 1];\n\t\t\t\t\tlet path = `./assets/images/cards/${filename}`;\n\t\t\t\t\tfsSuccess = await deleteFile(path);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\treturn dbSuccess && fsSuccess;\n\t\t\t})\n\t\t},\n\t\t\n\t\tdeleteGames: async (_, {games}) => {\n\t\t\t//console.log(\"games\", games);\n\t\t\treturn Promise.all(games.map(async (game) => {\n\t\t\t\tlet q1 = db.models.game_cards_stand.destroy({\n\t\t\t\t\twhere: {game_id: game.id}\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tlet q2 = db.models.game.destroy({\n\t\t\t\t\twhere: {id: game.id}\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\treturn (Promise.all([q1, q2]));\n\t\t\t}));\n\t\t},\n\t\t\n\t\tupsertGames: (_, {games}) => {\n\t\t\tconsole.log(\"games\", games);\n\t\t\treturn games.map((game) => {\n\t\t\t\tlet fields = Object.keys(game);\n\t\t\t\t\n\t\t\t\t//console.log(\"fields\", fields);\n\t\t\t\treturn db.models.game.upsert(game, {fields}).then(async (result) => {\n\t\t\t\t\tlet standOnCards = game.standOnCards;\n\t\t\t\t\t\n\t\t\t\t\tif (!game.id) {\n\t\t\t\t\t\tgame = await db.models.game.findOne({\n\t\t\t\t\t\t\t'order': [['id', 'DESC']]\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t//console.log(\"game\", game);\n\t\t\t\t\t//console.log(\"game.id\", game.id);\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tif (standOnCards) {\n\t\t\t\t\t\t// delete existing game_cards\n\t\t\t\t\t\tawait db.models.game_cards_stand.destroy({\n\t\t\t\t\t\t\twhere: {\n\t\t\t\t\t\t\t\tgame_id: game.id,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tlet game_cards = standOnCards.map((card) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tgame_id: game.id,\n\t\t\t\t\t\t\t\tcard_id: card.id,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(game_cards.length) {\n\t\t\t\t\t\t\tawait db.models.game_cards_stand.bulkCreate(game_cards,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfields: Object.keys(game_cards[0]),\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tgame = await db.models.game.findById(game.id);\n\t\t\t\t\t\n\t\t\t\t\treturn game;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t},\n\t\n\tUpload: GraphQLUpload,\n};\n\nasync function deleteFile(path) {\n\treturn new Promise((resolve, reject) => {\n\t\tfs.unlink(path, (err) => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tthrow err;\n\t\t\t\treject(false);\n\t\t\t} else {\n\t\t\t\tresolve(true)\n\t\t\t}\n\t\t})\n\t})\n}\n\nexport default resolvers;"]}